<!-- Model Comparison Chart Component -->
<div class="chart-container"
     data-chart-type="model-comparison"
     data-refresh-interval="{{ config.refresh_interval }}">

    <div class="chart-header d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="mb-0">{{ config.title or 'Model Performance Comparison' }}</h5>
            <small class="text-muted">Multi-dimensional performance analysis</small>
        </div>
        <div class="chart-controls">
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary active" data-chart-type="radar">Radar</button>
                <button type="button" class="btn btn-outline-secondary" data-chart-type="bar">Bar</button>
            </div>
            <button class="btn btn-sm btn-outline-secondary ms-2" id="export-model-chart">
                <i class="bi bi-download"></i>
            </button>
        </div>
    </div>

    <div class="chart-wrapper" style="height: {{ config.height }}px; width: {{ config.width }};">
        <canvas id="model-comparison-chart-{{ range(1000) | random }}"></canvas>
    </div>

    <div class="model-legend mt-3">
        <div class="row" id="model-legend-items">
            <!-- Legend items will be populated dynamically -->
        </div>
    </div>

    <div class="chart-loading d-none">
        <div class="text-center p-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div class="chart-error d-none">
        <div class="alert alert-warning" role="alert">
            Failed to load model comparison data. <a href="#" class="retry-chart">Retry</a>
        </div>
    </div>
</div>

<style>
.model-legend .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 2px;
    margin-right: 8px;
    border: 1px solid #dee2e6;
}

.legend-stats {
    font-size: 0.875rem;
    color: #6c757d;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('[data-chart-type="model-comparison"]');
    const canvas = container.querySelector('canvas');
    const legendContainer = container.querySelector('#model-legend-items');

    let chart = null;
    let chartData = null;
    let currentChartType = 'radar';
    let refreshInterval = null;

    function loadChart() {
        showLoading(true);

        fetch('/components/chart-data/model-comparison')
            .then(response => response.json())
            .then(data => {
                chartData = data;
                renderChart();
                renderLegend();

                showLoading(false);
                showError(false);
            })
            .catch(error => {
                console.error('Error loading model comparison:', error);
                showLoading(false);
                showError(true);
            });
    }

    function renderChart() {
        if (!chartData) return;

        if (chart) chart.destroy();

        const ctx = canvas.getContext('2d');

        if (currentChartType === 'radar') {
            chart = new Chart(ctx, chartData);
        } else {
            // Convert to bar chart
            const barData = {
                type: 'bar',
                data: {
                    labels: chartData.data.datasets.map(d => d.label),
                    datasets: chartData.data.labels.map((label, index) => ({
                        label: label,
                        data: chartData.data.datasets.map(d => d.data[index]),
                        backgroundColor: `hsla(${index * 72}, 70%, 50%, 0.6)`,
                        borderColor: `hsl(${index * 72}, 70%, 50%)`,
                        borderWidth: 1
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            };
            chart = new Chart(ctx, barData);
        }
    }

    function renderLegend() {
        if (!chartData) return;

        legendContainer.innerHTML = '';

        chartData.data.datasets.forEach((dataset, index) => {
            const legendItem = document.createElement('div');
            legendItem.className = 'col-md-6 legend-item';

            const avgScore = dataset.data.reduce((a, b) => a + b, 0) / dataset.data.length;

            legendItem.innerHTML = `
                <div class="legend-color" style="background-color: ${dataset.backgroundColor}"></div>
                <div>
                    <strong>${dataset.label}</strong>
                    <div class="legend-stats">
                        Avg Score: ${avgScore.toFixed(1)}/100
                    </div>
                </div>
            `;

            legendContainer.appendChild(legendItem);
        });
    }

    function showLoading(show) {
        container.querySelector('.chart-loading').classList.toggle('d-none', !show);
        container.querySelector('.chart-wrapper').classList.toggle('d-none', show);
    }

    function showError(show) {
        container.querySelector('.chart-error').classList.toggle('d-none', !show);
        container.querySelector('.chart-wrapper').classList.toggle('d-none', show);
    }

    // Chart type toggle
    container.querySelectorAll('[data-chart-type]').forEach(btn => {
        if (btn.dataset.chartType !== 'model-comparison') {
            btn.addEventListener('click', function() {
                container.querySelectorAll('[data-chart-type]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentChartType = this.dataset.chartType;
                renderChart();
            });
        }
    });

    // Export button
    container.querySelector('#export-model-chart').addEventListener('click', function() {
        if (chart) {
            const url = chart.toBase64Image();
            const link = document.createElement('a');
            link.download = 'model-comparison.png';
            link.href = url;
            link.click();
        }
    });

    // Retry button
    container.querySelector('.retry-chart').addEventListener('click', function(e) {
        e.preventDefault();
        loadChart();
    });

    // Auto-refresh
    function startRefresh() {
        const interval = parseInt(container.dataset.refreshInterval) * 1000;
        refreshInterval = setInterval(loadChart, interval);
    }

    // Initial load
    loadChart();
    startRefresh();

    // Cleanup
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) clearInterval(refreshInterval);
        if (chart) chart.destroy();
    });
});
</script>
