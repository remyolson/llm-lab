<!-- Cost Trends Chart Component -->
<div class="chart-container" 
     data-chart-type="cost-trends"
     data-refresh-interval="{{ config.refresh_interval }}"
     data-time-range="{{ config.time_range }}">
    
    <div class="chart-header d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="mb-0">{{ config.title or 'Cost Trends' }}</h5>
            <small class="text-muted">Daily costs and provider breakdown</small>
        </div>
        <div class="chart-controls">
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" data-view="daily">Daily</button>
                <button type="button" class="btn btn-outline-secondary active" data-view="breakdown">Breakdown</button>
            </div>
            <button class="btn btn-sm btn-outline-secondary ms-2" id="export-cost-chart">
                <i class="bi bi-download"></i>
            </button>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="chart-wrapper" style="height: {{ config.height }}px;">
                <canvas id="daily-costs-chart-{{ range(1000) | random }}"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-wrapper" style="height: {{ config.height }}px;">
                <canvas id="provider-breakdown-chart-{{ range(1000) | random }}"></canvas>
            </div>
        </div>
    </div>
    
    <div class="chart-loading d-none">
        <div class="text-center p-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
    
    <div class="chart-error d-none">
        <div class="alert alert-warning" role="alert">
            Failed to load cost data. <a href="#" class="retry-chart">Retry</a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('[data-chart-type="cost-trends"]');
    const dailyCanvas = container.querySelector('[id^="daily-costs-chart"]');
    const breakdownCanvas = container.querySelector('[id^="provider-breakdown-chart"]');
    
    let dailyChart = null;
    let breakdownChart = null;
    let refreshInterval = null;
    
    function loadCharts() {
        const timeRange = container.dataset.timeRange;
        const params = new URLSearchParams({
            hours: timeRange === '1h' ? 1 : timeRange === '24h' ? 24 : timeRange === '7d' ? 168 : 720
        });
        
        showLoading(true);
        
        fetch(`/components/chart-data/cost-trends?${params}`)
            .then(response => response.json())
            .then(data => {
                // Destroy existing charts
                if (dailyChart) dailyChart.destroy();
                if (breakdownChart) breakdownChart.destroy();
                
                // Create daily costs chart
                const dailyCtx = dailyCanvas.getContext('2d');
                dailyChart = new Chart(dailyCtx, data);
                
                // Create provider breakdown chart
                if (data.provider_breakdown) {
                    const breakdownCtx = breakdownCanvas.getContext('2d');
                    breakdownChart = new Chart(breakdownCtx, data.provider_breakdown);
                }
                
                showLoading(false);
                showError(false);
            })
            .catch(error => {
                console.error('Error loading cost charts:', error);
                showLoading(false);
                showError(true);
            });
    }
    
    function showLoading(show) {
        container.querySelector('.chart-loading').classList.toggle('d-none', !show);
        container.querySelector('.row').classList.toggle('d-none', show);
    }
    
    function showError(show) {
        container.querySelector('.chart-error').classList.toggle('d-none', !show);
        container.querySelector('.row').classList.toggle('d-none', show);
    }
    
    // View toggle buttons  
    container.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', function() {
            container.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const view = this.dataset.view;
            if (view === 'daily') {
                container.querySelector('.col-md-8').style.display = 'block';
                container.querySelector('.col-md-4').style.display = 'none';
            } else {
                container.querySelector('.col-md-8').style.display = 'none';
                container.querySelector('.col-md-4').style.display = 'block';
            }
        });
    });
    
    // Export button
    container.querySelector('#export-cost-chart').addEventListener('click', function() {
        if (dailyChart && breakdownChart) {
            // Create combined export
            const canvas = document.createElement('canvas');
            canvas.width = 1200;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // Draw both charts
            ctx.drawImage(dailyChart.canvas, 0, 0, 800, 600);
            ctx.drawImage(breakdownChart.canvas, 800, 0, 400, 600);
            
            const url = canvas.toDataURL();
            const link = document.createElement('a');
            link.download = 'cost-trends.png';
            link.href = url;
            link.click();
        }
    });
    
    // Retry button
    container.querySelector('.retry-chart').addEventListener('click', function(e) {
        e.preventDefault();
        loadCharts();
    });
    
    // Auto-refresh
    function startRefresh() {
        const interval = parseInt(container.dataset.refreshInterval) * 1000;
        refreshInterval = setInterval(loadCharts, interval);
    }
    
    // Initial load
    loadCharts();
    startRefresh();
    
    // Cleanup
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) clearInterval(refreshInterval);
        if (dailyChart) dailyChart.destroy();
        if (breakdownChart) breakdownChart.destroy();
    });
});
</script>