<!-- Performance Comparison Chart Component -->
<div class="chart-container" 
     data-chart-type="performance-comparison"
     data-refresh-interval="{{ config.refresh_interval }}"
     data-time-range="{{ config.time_range }}"
     data-providers="{{ config.providers | join(',') }}"
     data-models="{{ config.models | join(',') }}">
    
    <div class="chart-header d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="mb-0">{{ config.title or 'Performance Comparison' }}</h5>
            <small class="text-muted">Last {{ config.time_range }} - Updated every {{ config.refresh_interval }}s</small>
        </div>
        <div class="chart-controls">
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" data-time-range="1h">1H</button>
                <button type="button" class="btn btn-outline-secondary" data-time-range="24h">24H</button>
                <button type="button" class="btn btn-outline-secondary active" data-time-range="7d">7D</button>
                <button type="button" class="btn btn-outline-secondary" data-time-range="30d">30D</button>
            </div>
            <button class="btn btn-sm btn-outline-secondary ms-2" id="export-chart">
                <i class="bi bi-download"></i>
            </button>
        </div>
    </div>
    
    <div class="chart-wrapper" style="height: {{ config.height }}px; width: {{ config.width }};">
        <canvas id="performance-chart-{{ config.chart_type }}-{{ range(1000) | random }}"></canvas>
    </div>
    
    <div class="chart-loading d-none">
        <div class="text-center p-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
    
    <div class="chart-error d-none">
        <div class="alert alert-warning" role="alert">
            Failed to load chart data. <a href="#" class="retry-chart">Retry</a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('[data-chart-type="performance-comparison"]');
    const canvas = container.querySelector('canvas');
    const chartId = canvas.id;
    
    let chart = null;
    let refreshInterval = null;
    
    function loadChart() {
        const timeRange = container.dataset.timeRange;
        const providers = container.dataset.providers;
        const models = container.dataset.models;
        
        const params = new URLSearchParams({
            hours: timeRange === '1h' ? 1 : timeRange === '24h' ? 24 : timeRange === '7d' ? 168 : 720
        });
        
        if (providers) params.append('provider', providers);
        if (models) params.append('model', models);
        
        showLoading(true);
        
        fetch(`/components/chart-data/performance-comparison?${params}`)
            .then(response => response.json())
            .then(data => {
                if (chart) {
                    chart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                chart = new Chart(ctx, data);
                
                showLoading(false);
                showError(false);
            })
            .catch(error => {
                console.error('Error loading performance chart:', error);
                showLoading(false);
                showError(true);
            });
    }
    
    function showLoading(show) {
        container.querySelector('.chart-loading').classList.toggle('d-none', !show);
        container.querySelector('.chart-wrapper').classList.toggle('d-none', show);
    }
    
    function showError(show) {
        container.querySelector('.chart-error').classList.toggle('d-none', !show);
        container.querySelector('.chart-wrapper').classList.toggle('d-none', show);
    }
    
    // Time range buttons
    container.querySelectorAll('[data-time-range]').forEach(btn => {
        btn.addEventListener('click', function() {
            container.querySelectorAll('[data-time-range]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            container.dataset.timeRange = this.dataset.timeRange;
            loadChart();
        });
    });
    
    // Export button
    container.querySelector('#export-chart').addEventListener('click', function() {
        if (chart) {
            const url = chart.toBase64Image();
            const link = document.createElement('a');
            link.download = 'performance-comparison.png';
            link.href = url;
            link.click();
        }
    });
    
    // Retry button
    container.querySelector('.retry-chart').addEventListener('click', function(e) {
        e.preventDefault();
        loadChart();
    });
    
    // Auto-refresh
    function startRefresh() {
        const interval = parseInt(container.dataset.refreshInterval) * 1000;
        refreshInterval = setInterval(loadChart, interval);
    }
    
    // Initial load
    loadChart();
    startRefresh();
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        if (chart) {
            chart.destroy();
        }
    });
});
</script>